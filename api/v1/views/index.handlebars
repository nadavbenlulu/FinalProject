<style>
    /* עיצוב טופס ההתחברות */
    .login-section {
        background: #f4f4f9;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 30px;
        border: 1px solid #ddd;
        direction: rtl;
    }
    .login-section input {
        padding: 10px;
        margin: 5px;
        border-radius: 5px;
        border: 1px solid #ccc;
        width: 220px;
    }
    .login-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
    }
    
    /* עיצוב כללי */
    .container { direction: rtl; font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
    .product-list { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
    .product-card { display: flex; background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 20px; align-items: center; border: 1px solid #eee; transition: transform 0.2s; }
    .image-container { width: 180px; height: 150px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .product-image { max-width: 100%; max-height: 100%; object-fit: contain; }
    .product-info { flex-grow: 1; padding: 0 30px; }
    .product-title { font-size: 1.6rem; font-weight: bold; color: #333; margin: 0 0 10px 0; }
    .action-section { border-right: 1px solid #eee; padding-right: 30px; min-width: 180px; text-align: center; }
    .price-amount { font-size: 2.2rem; color: #d93025; font-weight: bold; margin: 5px 0; }
    .buy-button { background-color: #ffc107; color: #000; border: none; padding: 12px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; }
</style>

<div class="container">
    <h1>חנות Electrical Product</h1>

    <div class="login-section" id="loginArea">
        <h3>התחברות למערכת</h3>
        <input type="email" id="email" placeholder="כתובת אימייל">
        <input type="password" id="password" placeholder="סיסמה">
        <button class="login-btn" onclick="login()">התחבר עכשיו</button>
    </div>

    <div class="product-list">
        {{#each products}}
            <div class="product-card">
                <div class="image-container">
                    {{#if this.picname}}
                        <img src="/uploads/pics/{{this.picname}}" class="product-image">
                    {{else}}
                        <div style="color: #ccc;">אין תמונה</div>
                    {{/if}}
                </div>

                <div class="product-info">
                    <h3 class="product-title">{{this.pname}}</h3>
                    <div class="product-description">מכירה מיוחדת • אחריות יבואן</div>
                </div>

                <div class="action-section">
                    <div class="price-amount">₪{{this.price}}</div>
                    <button class="buy-button" onclick="addToCart('{{this._id}}')">הוסף לסל ></button>
                </div>
            </div>
        {{/each}}
    </div>
</div>

<script>
function login() {
    const emailVal = document.getElementById('email').value;
    const passVal = document.getElementById('password').value;

    fetch('/user/login', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        // כאן התיקון: אנחנו שולחים "email" ו-"password" בדיוק כמו בקונטרולר שלך
        body: JSON.stringify({ email: emailVal, password: passVal })
    })
    .then(res => res.json())
    .then(data => {
        if (data.token) {
            // שמירת הטוקן
            localStorage.setItem('token', data.token);
            alert('התחברת בהצלחה! מעביר אותך...');
            
            // ההפניה שביקשת
            window.location.href = '/product#'; 
        } else {
            // כאן תקבל את ההודעה "משתמש לא קיים במערכת" אם הפרטים שגויים
            alert('שגיאה: ' + (data.message || 'פרטים לא נכונים'));
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('תקלה בתקשורת עם השרת');
    });
}

function addToCart(productId) {
    fetch('/add-to-cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productId: productId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) alert('המוצר נשמר ב-Database!');
    });
}
</script>

